# File: backend/legal_concepts.py
from __future__ import annotations
from typing import List

# 最小の概念展開辞書（必要に応じて拡張）
# 口語→民法系の概念語（BM25で効く法的語彙へ寄せる）
# backend/legal_concepts.py（抜粋：置き換え）
_CONCEPT_MAP = {
    # --- オンライン言動 / 名誉・プライバシ ---
    "死ね": ["名誉毀損", "人格権", "不法行為", "侮辱", "慰謝料", "財産以外の損害", "名誉回復"],
    "殺す": ["名誉毀損", "人格権", "不法行為", "脅迫", "強迫", "慰謝料", "名誉回復"],
    "殺せ": ["名誉毀損", "人格権", "不法行為", "脅迫", "強迫", "慰謝料", "名誉回復"],
    "暴言": ["名誉毀損", "人格権", "不法行為", "侮辱", "慰謝料", "財産以外の損害"],
    "誹謗中傷": ["名誉毀損", "人格権", "侮辱", "社会的評価", "謝罪広告", "名誉回復"],
    "デマ": ["名誉毀損", "人格権", "不法行為", "謝罪広告", "名誉回復"],
    "虚偽の噂": ["名誉毀損", "人格権", "不法行為", "名誉回復"],
    "晒し": ["プライバシー", "人格権", "不法行為", "名誉毀損", "差止め", "慰謝料"],
    "個人情報晒し": ["プライバシー", "人格権", "不法行為", "差止め", "慰謝料"],
    "実名晒し": ["プライバシー", "人格権", "不法行為", "名誉毀損", "名誉回復"],
    "無断転載": ["人格権", "不法行為", "差止め", "慰謝料"],
    "勝手に写真": ["肖像権", "プライバシー", "人格権", "不法行為", "差止め", "慰謝料"],
    "盗撮": ["プライバシー", "人格権", "不法行為", "差止め", "慰謝料"],
    "なりすまし": ["人格権", "不法行為", "名誉毀損", "差止め", "慰謝料"],
    "悪質レビュー": ["名誉毀損", "人格権", "不法行為", "名誉回復"],

    # --- ハラスメント / つきまとい ---
    "ストーカー": ["人格権", "不法行為", "つきまとい", "差止め", "慰謝料"],
    "つきまとい": ["人格権", "不法行為", "差止め", "慰謝料"],
    "嫌がらせ": ["人格権", "不法行為", "名誉毀損", "侮辱", "慰謝料"],
    "パワハラ": ["人格権", "不法行為", "使用者責任", "慰謝料"],
    "セクハラ": ["人格権", "不法行為", "使用者責任", "慰謝料"],

    # --- 契約 / 取消・解除 / 返金 ---
    "キャンセルしたい": ["解除", "取消し", "債務不履行", "契約不適合責任", "返金", "不当利得"],
    "返金": ["解除", "取消し", "不当利得", "契約不適合責任"],
    "返品": ["契約不適合責任", "解除", "追完", "代金減額"],
    "初期不良": ["契約不適合責任", "追完", "代金減額", "解除", "損害賠償"],
    "定期購入 解約": ["解除", "合意解除", "債務不履行", "更新拒絶"],
    "サブスク 解約": ["解除", "合意解除", "不当利得", "債務不履行"],
    "二重請求": ["不当利得", "返還請求"],
    "課金ミス": ["不当利得", "返還請求"],
    "未成年 課金": ["未成年者取消権", "取消し", "不当利得"],
    "騙された": ["詐欺", "取消し", "不当利得", "損害賠償"],
    "脅されて契約": ["強迫", "取消し", "不当利得", "損害賠償"],
    "間違えて契約": ["錯誤", "取消し", "不当利得"],
    "契約書 おかしい": ["契約解釈", "信義則", "解除", "損害賠償"],
    "納期 遅れ": ["債務不履行", "損害賠償", "履行遅滞", "解除"],
    "品質 悪い": ["契約不適合責任", "追完", "代金減額", "解除", "損害賠償"],

    # --- 金銭 / 返済 / 保証 ---
    "借金 返してくれない": ["金銭消費貸借", "弁済", "履行遅滞", "損害賠償", "遅延損害金"],
    "お金を貸した": ["金銭消費貸借", "弁済", "履行遅滞", "遅延損害金"],
    "立替金": ["不当利得", "事務管理", "返還請求"],
    "返済 待って": ["履行の追完", "期限の利益", "合意"],
    "払えない": ["履行不能", "債務整理", "相殺"],
    "相殺したい": ["相殺", "債権者・債務者", "弁済"],
    "時効": ["消滅時効", "時効の援用", "更新", "完成猶予"],
    "督促": ["催告", "履行遅滞", "解除"],
    "違約金": ["損害賠償の予定", "違約金", "過大減額"],

    "保証人 になってと言われた": ["保証", "連帯保証", "極度額", "情報提供義務"],
    "保証人 やめたい": ["保証", "連帯保証", "更改", "免責"],
    "連帯保証 こわい": ["連帯保証", "保証", "求償権", "分別の利益なし"],

    # --- 不法行為 / 709・710 周辺（セット想起） ---
    "ケガ させられた": ["不法行為", "損害賠償", "慰謝料", "財産以外の損害", "過失相殺", "共同不法行為"],
    "事故 被害": ["不法行為", "損害賠償", "慰謝料", "過失相殺", "共同不法行為"],
    "風評被害": ["名誉毀損", "不法行為", "損害賠償", "名誉回復"],
    "職場の嫌がらせ": ["不法行為", "人格権", "使用者責任", "慰謝料"],
    "学校でのいじめ": ["不法行為", "人格権", "慰謝料", "名誉回復"],

    # --- 家族・婚姻 ---
    "離婚": ["離婚", "財産分与", "親権", "面会交流", "慰謝料"],
    "不倫 慰謝料": ["不法行為", "慰謝料", "財産以外の損害"],
    "婚約破棄": ["不法行為", "債務不履行", "損害賠償", "慰謝料"],
    "認知": ["親子", "扶養", "養育費"],
    "養育費": ["扶養義務", "債務名義", "強制執行"],

    # --- 相続 ---
    "相続": ["相続人", "法定相続分", "遺留分", "遺産分割", "代襲相続"],
    "遺留分 侵害": ["遺留分", "侵害額請求", "金銭債権"],
    "相続放棄": ["相続放棄", "熟慮期間", "限定承認"],
    "遺言 無効": ["遺言", "方式", "取消し", "無効"],
    "特別受益": ["遺産分割", "特別受益", "持戻し"],
    "寄与分": ["遺産分割", "寄与分"],

    # --- 物権 / 不動産 / 賃貸 ---
    "敷金 返して": ["敷金", "原状回復", "不当利得", "返還請求"],
    "原状回復": ["賃貸借", "善管注意義務", "通常損耗", "敷金"],
    "家賃 払ってくれない": ["賃貸借", "債務不履行", "解除", "明渡し", "損害賠償"],
    "更新 断られた": ["賃貸借", "正当事由", "更新拒絶"],
    "無断転貸": ["賃貸借", "契約違反", "解除", "明渡し"],
    "境界 トラブル": ["所有権", "境界", "妨害排除", "損害賠償"],
    "騒音": ["不法行為", "人格権", "差止め", "損害賠償"],
    "日照権": ["不法行為", "人格権", "差止め", "損害賠償"],
    "枝が越境": ["竹木の枝", "越境", "妨害排除", "損害賠償"],
    "無断駐車": ["所有権", "占有", "不法行為", "損害賠償", "不当利得"],

    # --- 取引形態 / 仕事 ---
    "業務委託 代金未払い": ["準委任", "請負", "報酬", "債務不履行", "損害賠償"],
    "請負 代金": ["請負", "報酬", "瑕疵修補", "契約不適合責任"],
    "NDA 破った": ["債務不履行", "損害賠償", "差止め"],
    "競業避止": ["債務不履行", "信義則", "差止め"],

    # --- 制限行為能力 / 代表的論点 ---
    "未成年 契約": ["未成年者取消権", "取消し", "不当利得"],
    "認知症 契約": ["意思能力", "取消し", "無効", "不当利得"],
    "代理人 なし": ["無権代理", "追認", "表見代理", "無効", "不当利得"],

    # --- 手元ワード → 民法語彙ブリッジ（709/710想起強化） ---
    "慰謝料": ["財産以外の損害", "不法行為", "名誉回復"],
    "精神的苦痛": ["慰謝料", "財産以外の損害", "不法行為"],
    "名誉": ["名誉毀損", "人格権", "名誉回復"],
    "脅迫": ["強迫", "取消し", "不法行為"],
    "強迫": ["取消し", "不法行為"],
    "侮辱": ["人格権", "名誉毀損", "慰謝料"],
    "過失": ["不法行為", "過失相殺", "損害賠償"],
    "共同": ["共同不法行為", "連帯責任"],
    "会社の責任": ["使用者責任", "不法行為", "損害賠償"],
}

# 検出したい危険語（これ自体をBM25で強くは使わない）
_LITERAL_RISK = {"死ね", "殺す", "殺せ"}


def expand_concepts(text: str) -> List[str]:
    found = []
    for key, vals in _CONCEPT_MAP.items():
        if key in text:
            found.extend(vals)
    # 重複除去
    return list(dict.fromkeys(found))


def literal_risk_tokens(text: str) -> set[str]:
    return {w for w in _LITERAL_RISK if w in text}
